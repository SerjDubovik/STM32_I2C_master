#include "stm32f10x.h"
#include "GPIO.h"


uint8_t I2C_Read(uint8_t reg_addr);


uint8_t temp;

int main(void)
{

	init_GPIO();

    relay_1(off);
    relay_2(off);

    blue_led(off);
    red_led(off);



    // настройка I2C1

    RCC->APB1ENR |=	RCC_APB1ENR_I2C1EN;		// Тактируем модуль I2C1

    I2C1->CR1 &= ~I2C_CR1_SMBUS;			// настраиваем модуль в режим I2C
    I2C2->CR2 &= ~I2C_CR2_FREQ;
    I2C1->CR2 |= 36;                    	// Установим частоту. Половина тактовой APB1= 36MHz
    I2C1->CCR = 180;                    	// 100 KHz
    I2C1->TRISE = 37;
    I2C1->CR1 |= I2C_CR1_PE;				// Включаем модуль



    temp = I2C_Read(0x00);



	for(;;)
	{


	} // скобка бесконечного цикла





} // скобка мейна



uint8_t I2C_Read(uint8_t reg_addr)
{

	// сбрасыаем для записи. 0 - запись
	// ставим для чтения. 1 - чтение

	uint8_t data;
	//стартуем
	I2C2->CR1 |= I2C_CR1_START;
	while(!(I2C2->SR1 & I2C_SR1_SB)){};
	(void) I2C2->SR1;

	//передаем адрес устройства
	I2C2->DR = 0x10;
	while(!(I2C2->SR1 & I2C_SR1_ADDR)){};
	(void) I2C2->SR1;
	(void) I2C2->SR2;

	//передаем адрес регистра
	I2C2->DR = reg_addr;
	while(!(I2C2->SR1 & I2C_SR1_TXE)){};
	I2C2->CR1 |= I2C_CR1_STOP;

	//рестарт!!!
	I2C2->CR1 |= I2C_CR1_START;
	while(!(I2C2->SR1 & I2C_SR1_SB)){};
	(void) I2C2->SR1;

	//передаем адрес устройства, но теперь для чтения
	I2C2->DR = 0x90;
	while(!(I2C2->SR1 & I2C_SR1_ADDR)){};
	(void) I2C2->SR1;
	(void) I2C2->SR2;

	//читаем
	I2C2->CR1 &= ~I2C_CR1_ACK;
	while(!(I2C2->SR1 & I2C_SR1_RXNE)){};
	data = I2C2->DR;
	I2C2->CR1 |= I2C_CR1_STOP;

	return data;
}



